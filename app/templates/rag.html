{% extends "base.html" %}
{% block content %}
<div class="flex justify-center items-start py-12 px-4">
  <div class="card-glass w-full max-w-4xl animate__animated animate__fadeIn space-y-6">

    <h2 class="text-3xl font-extrabold text-center text-indigo-300">RAG Pipeline</h2>

    <!-- ­UPLOAD ––––––––––––––––– -->
    <section class="bg-gray-800/70 rounded-xl p-6 space-y-4 border border-gray-700">
      <h3 class="text-xl font-semibold text-gray-200">Upload Document</h3>
      <form id="upload-form" enctype="multipart/form-data" class="flex flex-col sm:flex-row sm:items-center gap-4">
        <input  id="file" name="file" type="file" accept=".pdf"
                class="text-gray-300 file:bg-indigo-600 file:text-white file:rounded-lg
                       file:px-4 file:py-2 file:border-0 file:hover:bg-indigo-700"/>
        <button type="submit"
                class="px-5 py-2.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition font-semibold">
          Upload
        </button>
      </form>
    </section>

    <!-- ­SETTINGS –––––––––––––– -->
    <section class="bg-gray-800/70 rounded-xl p-6 space-y-4 border border-gray-700">
      <h3 class="text-xl font-semibold text-gray-200">RAG Settings</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="chunk-size" class="block text-sm font-medium text-gray-300 mb-1">
            Chunk Size (characters)
          </label>
          <input id="chunk-size" type="number" value="500" min="100" max="2000"
                 class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600
                        focus:ring-indigo-500 focus:outline-none"/>
        </div>
        <div>
          <label for="n-results" class="block text-sm font-medium text-gray-300 mb-1">
            Number of Results
          </label>
          <input id="n-results" type="number" value="3" min="1" max="10"
                 class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600
                        focus:ring-indigo-500 focus:outline-none"/>
        </div>
      </div>
    </section>

    <!-- ­SYSTEM PROMPT –––––––– -->
    <section class="bg-gray-800/70 rounded-xl p-6 space-y-4 border border-gray-700">
      <h3 class="text-xl font-semibold text-gray-200">System Prompt</h3>
      <textarea id="system-prompt" rows="4"
                class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600
                       focus:ring-indigo-500 focus:outline-none">You are a helpful assistant. You need to answer the user based on the context of the document. If the user asks anything which is not there in the context of the uploaded document, then just answer that you can't help with anything outside of the context of the document.</textarea>
    </section>

    <!-- ­CHAT HISTORY –––––––– -->
    <div id="chat-container"
         class="h-[40vh] overflow-y-auto rounded-xl bg-black/20 p-4 border border-gray-700 space-y-4"></div>

    <!-- ­typing dots -->
    <div id="typing-indicator" class="flex gap-1" style="display:none">
      <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
    </div>

    <!-- ­QUERY INPUT ––––––––––– -->
    <div class="flex gap-2">
      <input id="query" type="text" placeholder="Type your query…"
             class="flex-1 p-3 rounded-lg bg-gray-800 border border-gray-600
                    focus:ring-indigo-500 focus:outline-none placeholder-gray-400"/>
      <button id="send-btn"
              class="px-5 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition font-semibold">
        Send
      </button>
    </div>

  </div>
</div>

<script>
/* UPLOAD -------------------------------------------------- */
document.getElementById('upload-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fileEl = document.getElementById('file');
  if (!fileEl.files.length) return alert('Select a PDF first.');

  const formData = new FormData();
  formData.append('file', fileEl.files[0]);

  try {
    const res  = await fetch('/rag/api/upload', {method:'POST', body:formData});
    const data = await res.json();
    alert(data.message || data.error || 'Unknown response');
  } catch { alert('Network error'); }
});

/* CHAT ---------------------------------------------------- */
const chatContainer   = document.getElementById('chat-container');
const typingIndicator = document.getElementById('typing-indicator');
const queryInput      = document.getElementById('query');
const sendBtn         = document.getElementById('send-btn');

const scrollToBottom = () => chatContainer.scrollTo({top:chatContainer.scrollHeight, behavior:'smooth'});

sendBtn.addEventListener('click', async () => {
  const query = queryInput.value.trim();
  if (!query) return;

  const userBubble = document.createElement('div');
  userBubble.className = 'message-bubble user';
  userBubble.textContent = `You: ${query}`;
  chatContainer.appendChild(userBubble);
  scrollToBottom();

  typingIndicator.style.display = 'flex';

  const payload = {
    query,
    system_prompt : document.getElementById('system-prompt').value,
    chunk_size    : Number(document.getElementById('chunk-size').value),
    n_results     : Number(document.getElementById('n-results').value)
  };

  try {
    const res = await fetch('/rag/api/query', {
      method  : 'POST',
      headers : {'Content-Type':'application/json'},
      body    : JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());

    const reader  = res.body.getReader();
    const decoder = new TextDecoder();
    let mdBuffer  = '';

    const botBubble = document.createElement('div');
    botBubble.className = 'message-bubble llm';
    const streamDiv = document.createElement('div');
    botBubble.appendChild(streamDiv);
    chatContainer.appendChild(botBubble);

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      mdBuffer += decoder.decode(value);
      streamDiv.innerHTML = marked.parse(mdBuffer);
      hljs.highlightAll();
      scrollToBottom();
    }
  } catch (err) {
    const errB = document.createElement('div');
    errB.className = 'message-bubble llm text-red-400';
    errB.textContent = `Error: ${err.message || 'Network error'}`;
    chatContainer.appendChild(errB);
  } finally {
    typingIndicator.style.display = 'none';
    queryInput.value = '';
    scrollToBottom();
  }
});
</script>
{% endblock %}
