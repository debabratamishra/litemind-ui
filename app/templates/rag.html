{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto mt-8 mb-8 flex flex-col flex-grow">
    <h2 class="text-3xl font-bold mb-6 text-center text-indigo-300">RAG Pipeline</h2>

    <!-- Upload box -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-300">Upload Document</h3>
        <form id="upload-form" enctype="multipart/form-data" class="space-y-4">
            <input type="file" id="file" name="file" accept=".pdf"
                   class="mb-2 text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg
                          file:border-0 file:bg-indigo-600 file:text-white file:hover:bg-indigo-700">
            <button type="submit"
                    class="bg-indigo-600 hover:bg-indigo-700 p-3 rounded-lg font-semibold transition">
                Upload
            </button>
        </form>
    </div>

    <!-- Settings -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-300">RAG Settings</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="chunk-size" class="block text-sm font-medium text-gray-300">
                    Chunk Size (characters)
                </label>
                <input type="number" id="chunk-size" value="500" min="100" max="2000"
                       class="mt-1 w-full p-3 rounded-lg bg-gray-800 border border-gray-700
                              focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
            </div>

            <div>
                <label for="n-results" class="block text-sm font-medium text-gray-300">
                    Number of Results
                </label>
                <input type="number" id="n-results" value="3" min="1" max="10"
                       class="mt-1 w-full p-3 rounded-lg bg-gray-800 border border-gray-700
                              focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
            </div>
        </div>
    </div>

    <!-- System prompt -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-300">System Prompt</h3>
        <textarea id="system-prompt"
                  class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700
                         focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
                  rows="4">You are a helpful assistant.</textarea>
    </div>

    <!-- chat history -->
    <div id="chat-container" class="flex-grow h-[calc(100vh-28rem)] overflow-y-auto"></div>

    <!-- typing dots -->
    <div id="typing-indicator" class="typing">
        <span></span><span></span><span></span>
    </div>

    <!-- query input -->
    <div class="mt-4 flex space-x-2">
        <input type="text" id="query"
               class="flex-1 p-3 rounded-lg bg-gray-800 border border-gray-700
                      focus:outline-none focus:ring-2 focus:ring-indigo-500 transition
                      placeholder-gray-400"
               placeholder="Type your queryâ€¦">
        <button id="send-btn"
                class="bg-indigo-600 hover:bg-indigo-700 p-3 rounded-lg font-semibold transition">
            Send
        </button>
    </div>
</div>

<script>
/* ---------- Upload PDF ---------- */
document.getElementById('upload-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fileEl = document.getElementById('file');
  if (!fileEl.files.length) return alert('Select a PDF first.');

  const formData = new FormData();
  formData.append('file', fileEl.files[0]);

  try {
    const res  = await fetch('/rag/api/upload', { method: 'POST', body: formData });
    const data = await res.json();
    alert(data.message || data.error || 'Unknown response');
  } catch {
    alert('Error: Network error occurred');
  }
});

/* ---------- RAG query chat ---------- */
const chatContainer   = document.getElementById('chat-container');
const typingIndicator = document.getElementById('typing-indicator');
const sendBtn         = document.getElementById('send-btn');
const queryInput      = document.getElementById('query');

const scrollToBottom = () => {
  chatContainer.scrollTop = chatContainer.scrollHeight;
};

sendBtn.addEventListener('click', async () => {
  const query = queryInput.value.trim();
  if (!query) return;

  /* user bubble */
  const userBubble       = document.createElement('div');
  userBubble.className   = 'message-bubble user animate-fade-in';
  userBubble.textContent = `You: ${query}`;
  chatContainer.appendChild(userBubble);
  scrollToBottom();

  typingIndicator.style.display = 'flex';

  /* gather settings */
  const payload = {
    query,
    system_prompt: document.getElementById('system-prompt').value,
    chunk_size   : Number(document.getElementById('chunk-size').value),
    n_results    : Number(document.getElementById('n-results').value)
  };

  try {
    const res = await fetch('/rag/api/query', {
      method : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body   : JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(await res.text());

    const reader   = res.body.getReader();
    const decoder  = new TextDecoder();
    let   mdBuffer = '';

    const botBubble = document.createElement('div');
    botBubble.className = 'message-bubble llm';
    const streamDiv = document.createElement('div');
    botBubble.appendChild(streamDiv);
    chatContainer.appendChild(botBubble);

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      mdBuffer += decoder.decode(value);
      streamDiv.innerHTML = marked.parse(mdBuffer);
      hljs.highlightAll();
      scrollToBottom();
    }
  } catch (err) {
    const errBubble = document.createElement('div');
    errBubble.className = 'message-bubble llm text-red-500 animate-fade-in';
    errBubble.textContent = `Error: ${err.message || 'Network error'}`;
    chatContainer.appendChild(errBubble);
  } finally {
    typingIndicator.style.display = 'none';
    queryInput.value = '';
    scrollToBottom();
  }
});
</script>
{% endblock %}
