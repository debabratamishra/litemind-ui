{% extends "base.html" %}
{% block content %}

<div class="flex flex-col items-center justify-start w-full pt-6 pb-8 px-4">
  <!-- Responsive container -->
  <div class="w-full max-w-full sm:max-w-md md:max-w-lg lg:max-w-xl xl:max-w-2xl mx-auto">

    <!-- Chat area -->
    <div id="chat-container"
         class="max-w-full sm:max-w-md md:max-w-lg lg:max-w-xl xl:max-w-2xl mx-auto chat-outer-margin"
         style="margin-top:20px; margin-left:50px; margin-right:50px; height: 500px; overflow-y: auto;">
      
      <div class="message-bubble llm">
        <div class="font-semibold text-blue-200 mb-1">Assistant</div>
        <div class="text-[14px]">Hello! I'm your AI assistant. How can I help you today?</div>
      </div>
    </div>

    <!-- Prompt -->
    <form id="chat-form" class="w-full flex items-center justify-center mt-8" autocomplete="off" onsubmit="return false;">
      <div class="relative w-full max-w-xl">
        <input
          id="prompt"
          name="prompt"
          type="text"
          autocomplete="off"
          required
          placeholder="Ask me anything..."
          class="w-full rounded-full pl-5 pr-12 py-3 bg-white/10 border border-white/20 text-white placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          style="font-size: 14px;"
        />
      </div>
    </form>

  </div>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const promptInput = document.getElementById('prompt');

let isStreaming = false;
let shouldAutoScroll = true;

// Auto-resize input
promptInput.addEventListener('input', () => {
  promptInput.style.height = 'auto';
  promptInput.style.height = Math.min(promptInput.scrollHeight, 200) + 'px';
});

// Submit on Enter, allow Shift+Enter for newline
promptInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

const scrollToBottom = () => {
  chatContainer.scrollTop = chatContainer.scrollHeight;
};

chatContainer.addEventListener('scroll', () => {
  const isAtBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 32;
  shouldAutoScroll = isAtBottom;
});

function createUserMessage(text) {
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble user bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl px-4 py-3 ml-auto max-w-[80%] shadow';
  bubble.innerHTML = `<div class="font-semibold text-[13px] mb-1 text-right">You</div>
    <div class="text-[13px] text-right">${text}</div>`;
  return bubble;
}

function createAIMessage() {
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble llm bg-gray-700/80 text-gray-100 rounded-xl px-4 py-3 max-w-[80%] shadow';
  bubble.innerHTML = `<div class="font-semibold text-blue-200 mb-1">Assistant</div>
    <div class="ai-response text-[13px]"></div>`;
  return { bubble, streamDiv: bubble.querySelector('.ai-response') };
}

async function sendMessage() {
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  promptInput.disabled = true;
  isStreaming = true;
  shouldAutoScroll = true;

  const userMsg = createUserMessage(prompt);
  chatContainer.appendChild(userMsg);
  scrollToBottom();
  promptInput.value = '';
  promptInput.style.height = '44px';

  const typingBubble = document.createElement('div');
  typingBubble.className = 'message-bubble llm bg-gray-700/80 text-gray-100 rounded-xl px-4 py-3 max-w-[80%] shadow';
  typingBubble.innerHTML = `<div class="font-semibold text-blue-200 mb-1">Assistant</div>
    <div>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
    </div>`;
  chatContainer.appendChild(typingBubble);
  scrollToBottom();

  try {
    const res = await fetch('/chat/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({prompt})
    });

    if (!res.ok) throw new Error(await res.text());

    chatContainer.removeChild(typingBubble);
    const { bubble, streamDiv } = createAIMessage();
    chatContainer.appendChild(bubble);
    scrollToBottom();

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let mdBuffer = '';

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      mdBuffer += decoder.decode(value);
      streamDiv.innerHTML = marked.parse(mdBuffer);
      hljs.highlightAll();
      if (shouldAutoScroll) scrollToBottom();
    }

  } catch (err) {
    chatContainer.removeChild(typingBubble);
    const { bubble, streamDiv } = createAIMessage();
    streamDiv.innerHTML = `<p class="text-red-400">‚ùå Error: ${err.message || 'Network error'}</p>`;
    chatContainer.appendChild(bubble);
    scrollToBottom();
  } finally {
    isStreaming = false;
    promptInput.disabled = false;
    promptInput.focus();
    scrollToBottom();
  }
}

// Focus input when page loads
document.addEventListener('DOMContentLoaded', () => promptInput.focus());
</script>

{% endblock %}