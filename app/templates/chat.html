{% extends "base.html" %}
{% block content %}
<div class="flex justify-center items-start py-12 px-4">
  <div class="card-glass w-full max-w-4xl animate__animated animate__fadeIn space-y-6">

    <h2 class="text-3xl font-extrabold text-center text-indigo-300">Chat with LLM</h2>

    <!-- message history -->
    <div id="chat-container"
         class="h-[60vh] overflow-y-auto space-y-4 rounded-xl bg-gray-800/70 p-4 border border-gray-700"></div>

    <!-- typing dots -->
    <div id="typing-indicator" class="flex gap-1" style="display:none">
      <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
    </div>

    <!-- prompt input -->
    <form id="chat-form" class="flex gap-2" autocomplete="off" onsubmit="return false;">
      <input  id="prompt"
              type="text"
              placeholder="Type your messageâ€¦"
              class="flex-1 p-3 rounded-lg bg-gray-800 border border-gray-700
                     focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400"/>
      <button id="send-btn"
              class="px-5 py-3 rounded-lg font-semibold bg-gradient-to-r from-indigo-500 to-purple-600
                     hover:from-indigo-600 hover:to-purple-700 transition">Send</button>
    </form>

  </div>
</div>

<script>
const chatContainer   = document.getElementById('chat-container');
const promptInput     = document.getElementById('prompt');
const typingIndicator = document.getElementById('typing-indicator');
const sendBtn         = document.getElementById('send-btn');

const scrollToBottom = () => chatContainer.scrollTo({top : chatContainer.scrollHeight, behavior : 'smooth'});

sendBtn.addEventListener('click', async () => {
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  /* user bubble */
  const userBubble = document.createElement('div');
  userBubble.className   = 'message-bubble user';
  userBubble.textContent = `You: ${prompt}`;
  chatContainer.appendChild(userBubble);
  scrollToBottom();

  typingIndicator.style.display = 'flex';

  try {
    const res = await fetch('/chat/api/chat', {
      method  : 'POST',
      headers : {'Content-Type':'application/json'},
      body    : JSON.stringify({prompt})
    });
    if (!res.ok) throw new Error(await res.text());

    const reader  = res.body.getReader();
    const decoder = new TextDecoder();
    let mdBuffer  = '';

    const botBubble = document.createElement('div');
    botBubble.className = 'message-bubble llm';
    const streamDiv = document.createElement('div');
    botBubble.appendChild(streamDiv);
    chatContainer.appendChild(botBubble);

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      mdBuffer += decoder.decode(value);
      streamDiv.innerHTML = marked.parse(mdBuffer);
      hljs.highlightAll();
      scrollToBottom();
    }
  } catch (err) {
    const errB = document.createElement('div');
    errB.className = 'message-bubble llm text-red-400';
    errB.textContent = `Error: ${err.message || 'Network error'}`;
    chatContainer.appendChild(errB);
  } finally {
    typingIndicator.style.display = 'none';
    promptInput.value = '';
    scrollToBottom();
  }
});
</script>
{% endblock %}
